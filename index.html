<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“– è–ç¶“ + AI è§£é‡‹ + åœ°åœ–</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background:#f8f8f8; margin:0; }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    #explainButton, #geoButton { font-size: 0.9rem; padding: 0.3rem 1rem; }
    #bibleSection { background: #e6f0ff; height: 50svh; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
    #bibleContent { flex:1; overflow-y:auto; background:white; padding:12px; border-radius:8px; box-shadow: inset 0 0 3px rgba(0,0,0,0.1); }
    #aiSection { background: #e6f0ff; height: 50svh; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
    #output { flex:1; overflow-y:auto; background:white; padding:12px; border-radius:8px; box-shadow: inset 0 0 3px rgba(0,0,0,0.1); font-size:0.95rem; margin-bottom:8px; }
    #versionTag { position: fixed; bottom: 2px; right: 6px; font-size: 0.7rem; color: gray; background: rgba(255,255,255,0.5); padding: 2px 4px; border-radius: 3px; }
  </style>
</head>
<body class="flex flex-col h-screen">
<div class="flex-1 flex flex-col overflow-hidden">
  <div id="bibleSection" class="shadow-md rounded-b-lg">
    <h1 class="text-2xl font-bold text-center mb-3 text-blue-700">ğŸ“– è–ç¶“é–±è®€å™¨</h1>
    <div id="loadError" class="hidden bg-red-100 text-red-700 p-2 mb-2 rounded"></div>
    <div class="grid grid-cols-3 gap-3 mb-3">
      <select id="bookSelect" class="p-3 border rounded-lg shadow-sm w-full"><option value="">è«‹é¸æ“‡æ›¸å·</option></select>
      <select id="chapterSelect" class="p-3 border rounded-lg shadow-sm w-full" disabled><option value="">è«‹é¸æ“‡ç« ç¯€</option></select>
      <select id="verseSelect" class="p-3 border rounded-lg shadow-sm w-full" disabled><option value="">å…¨éƒ¨ç¶“æ–‡</option></select>
    </div>
    <div class="flex justify-between items-center mb-2">
      <button id="prevChapter" class="bg-gray-300 px-3 py-1 rounded disabled:opacity-40" disabled>ä¸Šä¸€ç« </button>
      <div class="flex gap-2">
        <button id="nextChapter" class="bg-gray-300 px-3 py-1 rounded disabled:opacity-40" disabled>ä¸‹ä¸€ç« </button>
        <button id="explainButton" class="bg-gradient-to-r from-green-500 to-green-700 text-white rounded shadow disabled:opacity-40" disabled>AIè§£é‡‹</button>
        <button id="geoButton" class="bg-gradient-to-r from-blue-400 to-blue-700 text-white rounded shadow disabled:opacity-40" disabled>åœ°ç†ä½ç½®</button>
      </div>
    </div>
    <div id="bibleContent" class="no-scrollbar text-lg leading-relaxed">
      ğŸ“– è«‹å…ˆé¸æ“‡æ›¸å·å’Œç« ç¯€ä¾†é–±è®€è–ç¶“ã€‚
    </div>
  </div>

  <div id="aiSection" class="rounded-t-lg shadow-md">
    <div id="output" class="no-scrollbar"></div>
    <div id="loadingIndicator" class="hidden text-center mt-1 text-blue-600 text-sm">ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­...</div>
  </div>
</div>

<div id="versionTag">Powered by Google Gemini AIè§£é‡‹å…§å®¹åªä¾›åƒè€ƒ 080825 1422</div>

<script type="module">
const GEMINI_KEY = "AIzaSyBURyCnTRY5pO0OZjyMRI37jYEU_tWShhg";

const bookSelect=document.getElementById('bookSelect');
const chapterSelect=document.getElementById('chapterSelect');
const verseSelect=document.getElementById('verseSelect');
const bibleContentDiv=document.getElementById('bibleContent');
const outputDiv=document.getElementById('output');
const explainButton=document.getElementById('explainButton');
const geoButton=document.getElementById('geoButton');
const loading=document.getElementById('loadingIndicator');
const prevBtn=document.getElementById('prevChapter');
const nextBtn=document.getElementById('nextChapter');
const loadError=document.getElementById('loadError');
let bibleData={};

// è§£æ TXT
function parseBibleTXT(text){
  const lines=text.split('\n');
  const data={};
  lines.forEach(l=>{
    const m=l.match(/^(.+?)(?:\s)?(\d+):(\d+)\s(.+)$/);
    if(m){
      const[_,book,ch,vs,ct]=m;
      data[book]=data[book]||{};
      data[book][ch]=data[book][ch]||{};
      data[book][ch][vs]=`${vs} ${ct}`;
    }
  });
  return data;
}

// è¼‰å…¥ç¶“æ–‡
async function loadBible(){
  try{
    const res=await fetch('chinese_union_trad_trad.txt');
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw=await res.text();
    bibleData=parseBibleTXT(raw);
    for(const b in bibleData){
      let o=document.createElement('option');
      o.value=b;o.textContent=b;
      bookSelect.appendChild(o);
    }
  }catch(e){
    loadError.textContent="âŒ è–ç¶“è¼‰å…¥å¤±æ•—ï¼š"+e.message;
    loadError.classList.remove('hidden');
  }
}
loadBible();

// æ›¸å·é¸æ“‡
bookSelect.addEventListener('change',()=>{
  const b=bookSelect.value;
  chapterSelect.innerHTML='<option value="">è«‹é¸æ“‡ç« ç¯€</option>';
  verseSelect.innerHTML='<option value="">å…¨éƒ¨ç¶“æ–‡</option>';
  bibleContentDiv.textContent="ğŸ“– è«‹é¸æ“‡ç« ç¯€";
  verseSelect.disabled=true;
  explainButton.disabled=true;
  geoButton.disabled=true;
  if(!b){chapterSelect.disabled=true;return;}
  chapterSelect.disabled=false;
  Object.keys(bibleData[b]).forEach(ch=>{
    let o=document.createElement('option');
    o.value=ch;o.textContent=`ç¬¬${ch}ç« `;
    chapterSelect.appendChild(o);
  });
});

// ç« ç¯€é¸æ“‡
chapterSelect.addEventListener('change',()=>{
  const b=bookSelect.value;const ch=chapterSelect.value;
  if(!b||!ch)return;
  verseSelect.innerHTML='<option value="">å…¨éƒ¨ç¶“æ–‡</option>';
  Object.keys(bibleData[b][ch]).forEach(v=>{
    let o=document.createElement('option');
    o.value=v;o.textContent=`ç¬¬${v}ç¯€`;
    verseSelect.appendChild(o);
  });
  verseSelect.disabled=false;
  showChapter();
});

// é¡¯ç¤ºå…§å®¹
verseSelect.addEventListener('change',()=>showChapter());

function showChapter(){
  const b=bookSelect.value;const ch=chapterSelect.value;const v=verseSelect.value;
  if(!b||!ch){bibleContentDiv.textContent="ğŸ“– è«‹é¸æ“‡æ›¸å·å’Œç« ç¯€";return;}
  if(v){
    bibleContentDiv.innerHTML=`<p>${bibleData[b][ch][v]}</p>`;
  }else{
    bibleContentDiv.innerHTML=Object.values(bibleData[b][ch]).map(t=>`<p>${t}</p>`).join('');
  }
  explainButton.disabled=false;
  geoButton.disabled=false;
  prevBtn.disabled=!bibleData[b][parseInt(ch)-1];
  nextBtn.disabled=!bibleData[b][parseInt(ch)+1];
}
prevBtn.onclick=()=>{chapterSelect.value=parseInt(chapterSelect.value)-1;verseSelect.value="";showChapter();};
nextBtn.onclick=()=>{chapterSelect.value=parseInt(chapterSelect.value)+1;verseSelect.value="";showChapter();};

// âœ… AI è§£é‡‹ï¼ˆä½¿ç”¨ä½ çš„æ–°æç¤ºï¼‰
explainButton.onclick=async()=>{
  const b=bookSelect.value,ch=chapterSelect.value,v=verseSelect.value;
  let passage=bibleContentDiv.innerText;
  if(!b||!ch)return;
  if(passage.length>4000) passage=passage.substring(0,4000)+" ...ï¼ˆå…§å®¹å·²æˆªæ–·ï¼‰";

  loading.classList.remove("hidden");
  outputDiv.innerHTML="ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­...";

  const target=v?`ç¬¬${v}ç¯€`:`ç¬¬${ch}ç« `;
  const prompt=v?
`è«‹ç”¨ä¸­æ–‡ï¼ˆç¹é«”ï¼‰ä¸¦ä»¥åŸºç£æ•™ä¿¡ä»°å’Œè–ç¶“çœŸç†ç‚ºåŸºç¤ï¼Œè§£é‡‹è–ç¶“ ${b} ${target}ã€‚

ğŸ“Œ å¦‚æœæ˜¯ç‰¹å®šç¯€ï¼Œè«‹æä¾›ï¼š
- ã€ç¶“æ–‡è§£é‡‹ã€‘è©³ç´°é—¡è¿°è©²ç¯€çš„å«ç¾©ã€‚
- ã€ç¥å­¸èˆ‡å•Ÿç¤ºã€‘èªªæ˜å±¬éˆåŠç¥å­¸é‡é»ã€‚
- ã€èƒŒæ™¯èˆ‡å¼•ç”¨ã€‘è£œå……æ­·å²èƒŒæ™¯åŠç›¸é—œç¶“æ–‡æ”¯æŒã€‚
- ã€æ‡‰ç”¨èˆ‡åæ€ã€‘çµ¦å‡ºå±¬éˆæ‡‰ç”¨èˆ‡é»˜æƒ³æ–¹å‘ã€‚

âš ï¸ å›è¦†å¿…é ˆæ ¹æ“šè–ç¶“æ¬Šå¨å’ŒåŸºç£æ•™ä¿¡ä»°åŸå‰‡æ’°å¯«ã€‚
ç¶“æ–‡å…§å®¹å¦‚ä¸‹ï¼š
${passage}`
:
`è«‹ç”¨ä¸­æ–‡ï¼ˆç¹é«”ï¼‰ä¸¦ä»¥åŸºç£æ•™ä¿¡ä»°å’Œè–ç¶“çœŸç†ç‚ºåŸºç¤ï¼Œè§£é‡‹è–ç¶“ ${b} ${target}ã€‚

ğŸ“Œ å¦‚æœæ˜¯æ•´ç« ï¼Œè«‹æä¾›ï¼š
- ã€ç¶“æ–‡æ¦‚è¦ã€‘æ¦‚è¿°æ­¤ç« å…§å®¹èˆ‡ä¸»è¦äº‹ä»¶ã€‚
- ã€ç¶“æ–‡è§£é‡‹ã€‘è©³ç´°é—¡è¿°è©²ç¯€çš„å«ç¾©ã€‚
- ã€ç¥å­¸é‡é»ã€‘æŒ‡å‡ºæ ¸å¿ƒç¥å­¸ä¿¡æ¯ã€æ•‘æ©å•Ÿç¤ºåŠå±¬éˆä¿¡æ¯ã€‚
- ã€æ­·å²æ–‡åŒ–èƒŒæ™¯ã€‘è£œå……èˆ‡ç†è§£æœ¬ç« ç›¸é—œçš„èƒŒæ™¯è³‡æ–™ã€‚
- ã€å¼•ç”¨ã€‘åˆ—å‡ºå…¶ä»–è–ç¶“ç›¸é—œç¶“æ–‡ï¼Œä¸¦èªªæ˜å…¶é—œè¯ã€‚
- ã€å±¬éˆæ‡‰ç”¨ã€‘æä¾›å¦‚ä½•å°‡æ­¤ç« çš„ä¿¡æ¯æ‡‰ç”¨æ–¼ä¿¡å¾’ç”Ÿæ´»ã€‚
- ã€é»˜æƒ³èˆ‡åæ€å•é¡Œã€‘æå‡º2-3å€‹å¼•å°æ€è€ƒèˆ‡éˆä¿®çš„å•é¡Œã€‚

âš ï¸ å›è¦†å¿…é ˆæ ¹æ“šè–ç¶“æ¬Šå¨å’ŒåŸºç£æ•™ä¿¡ä»°åŸå‰‡æ’°å¯«ã€‚
ç¶“æ–‡å…§å®¹å¦‚ä¸‹ï¼š
${passage}`;

  try{
    const endpoint=`https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`;
    const payload={contents:[{parts:[{text:prompt}]}]};
    const res=await fetch(endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    outputDiv.innerHTML=data.candidates?.[0]?.content?.parts?.map(p=>p.text).join("\n").replace(/\n/g,"<br>")||"âš ï¸ AI æ²’æœ‰å›è¦†";
  }catch(e){
    outputDiv.textContent="âŒ AI è§£é‡‹å¤±æ•—ï¼š"+e.message;
  }
  loading.classList.add("hidden");
};

// âœ… åœ°ç†èƒŒæ™¯ï¼ˆåªæ–‡å­—è§£é‡‹ï¼‰
geoButton.onclick=async()=>{
  const b=bookSelect.value,ch=chapterSelect.value,v=verseSelect.value;
  if(!b||!ch)return;
  loading.classList.remove("hidden");
  outputDiv.innerHTML="ğŸŒ æ­£åœ¨ç²å–åœ°ç†è³‡æ–™...";

  try{
    const endpoint=`https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`;
    const target=v?`ç¬¬${v}ç¯€`:`ç¬¬${ch}ç« `;
    const prompt=`è«‹æä¾›ã€Š${b} ${target}ã€‹çš„åœ°ç†èƒŒæ™¯è³‡è¨Šï¼Œæè¿°å‡ºç¾çš„åœ°ååŠå…¶ç¾ä»£ä½ç½®ï¼ˆåƒ…æ–‡å­—ï¼Œç„¡éœ€ä»»ä½•é€£çµï¼‰ï¼š`;
    const payload={contents:[{parts:[{text:prompt}]}]};
    const res=await fetch(endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    let geoText=data.candidates?.[0]?.content?.parts?.map(p=>p.text).join("\n")||"âš ï¸ ç„¡å›è¦†";
    outputDiv.innerHTML="<strong>ğŸ“ åœ°ç†ä½ç½®ï¼š</strong><br>"+geoText.replace(/\n/g,"<br>");
  }catch(e){
    outputDiv.textContent="âŒ åœ°ç†è³‡æ–™ç²å–å¤±æ•—ï¼š"+e.message;
  }
  loading.classList.add("hidden");
};
</script>
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}</script>
</body>
</html>
